<?xml version="1.0" encoding="utf-8"?>
<odoo>
<template id="report_consolidate_by_tariff_document">
    <t t-call="web.external_layout">
        <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
        <t t-set="address">
            <div t-field="doc.partner_id"
                t-options='{"widget": "contact", "fields": ["address", "name","phone"], "no_marker": True}' />
            <p t-if="doc.partner_id.vat"><t t-esc="doc.company_id.country_id.vat_label or 'Tax ID'"/>: <span t-field="doc.partner_id.vat"/></p>
        </t>
        <div class="page">
            <div class="oe_structure"/>
            <h2 class="mt16">
                <span>Orden # </span>
                <span t-field="doc.name"/>
            </h2>
            <div class="row mt32 mb32" id="informations">
                <div class="col-auto col-3 mw-100 mb-2">
                    <strong>Fecha:</strong>
                    <p class="m-0" t-field="doc.date"/>
                </div>
                <div class="col-auto col-3 mw-100 mb-2">
                    <strong>Tipo:</strong>
                    <p class="m-0" t-field="doc.type_id"/>
                </div>
                <div class="col-auto col-3 mw-100 mb-2" name="expiration_date" t-if="doc.origin_port_id">
                    <strong>Puerto de Embarque:</strong>
                    <p class="m-0 text-uppercase">
                        <t t-if="doc.country_id">
                            <span t-field="doc.country_id"/>/
                        </t>
                        <span t-field="doc.origin_port_id"/>
                    </p>
                </div>
                <div class="col-auto col-3 mw-100 mb-2" name="expiration_date" t-if="doc.destination_port_id">
                    <strong>Puerto de Llegada:</strong>
                    <p class="m-0 text-uppercase">
                        <span t-field="doc.company_id.country_id"/>/<span t-field="doc.destination_port_id"/>
                    </p>
                </div>
            </div>
            <t t-set="objects" t-value="doc.get_line_by_tariff()" />
            <t t-set="total_weight" t-value="0.00" />
            <t t-foreach="objects" t-as="t">
                <br/><br/>
                <div class="row mt32 mb32" id="arancel_label">
                    <div class="col-auto col-12 mw-100 mb-2">
                        <span><strong>Posición Arancelaria:</strong> <t class="text-left" t-esc="t_value['tariff_code']"/></span>
                    </div>
                </div>
                 <div class="row mt32 mb32" id="declaration_label">
                      <div class="col-auto col-12 mw-100 mb-2">
                        <span><strong>Declaración en aduana:</strong> <t class="text-left" t-esc="t_value['tariff_name']"/></span>
                    </div>
                </div>
                <table class="table table-sm o_main_table">
                    <thead>
                        <tr>
                            <th name="th_cant" class="text-right">Cantidad</th>
                            <th name="th_number">Número</th>
                            <th name="th_descritcion">Descripción</th>
                            <th name="th_weigh" class="text-right">Peso Kg</th>
                            <th name="th_price" class="text-right">Valor / Unit</th>
                            <th name="th_total" class="text-right">Valor Total</th>

                        </tr>
                    </thead>
                    <tbody class="sale_tbody">
                            <t t-foreach="t_value['line']" t-as="line">
                                <tr>
                                    <th name="td_cant" class="text-right">
                                        <span t-field="line.product_qty" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/>
                                    </th>
                                    <th name="td_number">
                                        <span t-field="line.product_id.default_code"/>
                                    </th>
                                    <th name="td_descritcion" >
                                        <span t-field="line.product_id.ref_import" t-if="line.product_id.ref_import"/>
                                        <span t-field="line.product_id.name" t-if="not line.product_id.ref_import"/>
                                    </th>
                                    <th name="th_weigh" class="text-right">
                                        <span t-field="line.product_id.weight" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/>
                                    </th>
                                    <th name="th_price" class="text-right">
                                        <span t-field="line.price_unit" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/>
                                    </th>
                                    <th name="th_total" class="text-right">
                                        <span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/>
                                    </th>

                                </tr>
                                <t t-set="total_weight" t-value="total_weight + line.product_weight" />
                            </t>
                    </tbody>
                    <tfooter>
                         <th name="td_cant" class="text-right">
                            <span t-esc="t_value['product_qty']" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/>
                        </th>
                         <th name="td_cant" colspan="4"/>
                        <th name="td_cant" class="text-right">
                            <span t-esc="t_value['fob']" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/>
                        </th>
                    </tfooter>
            </table>
            </t>
            <br/>
            <div class="row mt32 mb32" id="totals" t-if="doc.state in ['draft','calculate']">
                <div class="col-auto col-4 mw-100 mb-2">
                    <h4>Total Kg: <span t-esc="total_weight" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/></h4>
                </div>
                <div class="col-auto col-4 mw-100 mb-2 text-right" name="total_details">
                    <t t-set="total_cf" t-value="doc.approximate_expenses + doc.amount_fob"/>
                    <t t-set="total_approximate_insurance" t-value="total_cf * (doc.approximate_insurance_costs/100)"/>
                    <table class="table table-condensed">
                        <tbody>
                            <tr>
                                <td><strong>VALOR TOTAL FOB. <span t-field="doc.company_id.currency_id.name" />(<span t-field="doc.company_id.currency_id.symbol" />)</strong></td>
                                <td><span t-field="doc.amount_fob" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>GASTO APROXIMADO</strong></td>
                                <td><span t-field="doc.approximate_expenses" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>VALOR VALOR C&amp;F. <span t-field="doc.company_id.currency_id.name" />(<span t-field="doc.company_id.currency_id.symbol" />)</strong></td>
                                <td><span t-esc="total_cf" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>GASTO APROX. SEGURO</strong></td>
                                <td><span t-esc="total_approximate_insurance" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>VALOR TOTAL CIF APROX. <span t-field="doc.company_id.currency_id.name" />(<span t-field="doc.company_id.currency_id.symbol" />)</strong></td>
                                <td><span t-esc="total_cf + total_approximate_insurance" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row mt32 mb32" id="totals_kg" t-if="doc.state in ['approved','confirmed','done']">
                <div class="col-auto col-4 mw-100 mb-2">
                    <h4>Total Kg: <span t-esc="total_weight" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/></h4>
                </div>
            </div>
            <div class="row mt32 mb32" id="totals_kg" t-if="doc.state in ['approved','confirmed','done']">
                 <div class="col-auto col-8 mw-100 mb-2">
                    <table class="table table-condensed">
                        <thead>
                            <tr>
                                <th>Termino</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="doc.breakdown_expenses_ids" t-as="expenses">
                                <tr>
                                    <td><span t-field="expenses.terms_id"/></td>
                                    <td class="text-right"><span t-field="expenses.amount" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
                <div class="col-auto col-4 mw-100 mb-2 text-right" name="total_details">
                    <table class="table table-condensed">
                        <tbody>
                            <tr>
                                <td><strong>VALOR FOB. <span t-field="doc.company_id.currency_id.name" />(<span t-field="doc.company_id.currency_id.symbol" />)</strong></td>
                                <td><span t-field="doc.amount_fob" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>TOTAL GASTOS</strong></td>
                                <td><span t-esc="doc.amount_total - doc.amount_fob" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>TOTAL <span t-field="doc.company_id.currency_id.name" />(<span t-field="doc.company_id.currency_id.symbol" />)</strong></td>
                                <td><span t-field="doc.amount_total" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></td>
                            </tr>
                            <tr>
                                <td><strong>% DE GASTOS</strong></td>
                                <td><span t-esc="doc.factor" t-options='{"widget": "float", "decimal_precision": "Product Unit of Measure"}'/>%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


        </div>
    </t>
</template>

<template id="report_consolidate_by_tariff">
    <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
            <t t-call="ek_purchase_import_liquidation.report_consolidate_by_tariff_document" t-lang="doc.partner_id.lang"/>
        </t>
    </t>
</template>


<record id="action_report_consolidate_by_tariff" model="ir.actions.report">
    <field name="name">Consolidado por partidas</field>
    <field name="model">ek.import.liquidation</field>
    <field name="report_type">qweb-pdf</field>
    <field name="report_name">ek_purchase_import_liquidation.report_consolidate_by_tariff</field>
    <field name="report_file">ek_purchase_import_liquidation.report_consolidate_by_tariff</field>
    <field name="print_report_name">'Consolidado - %s' % (object.name)</field>
    <field name="binding_model_id" ref="model_ek_import_liquidation"/>
    <field name="binding_type">report</field>
</record>

</odoo>
